define(["require","exports","tslib","react","react-redux","typescript/libraries/api_v2/redux/comments2","typescript/libraries/api_v2/redux/media_addon","typescript/component_libraries/files_components/src/blades/comments/index","typescript/component_libraries/flows/src/components/approval-forms/index","typescript/libraries/file-viewer/src/comments2/plugin/types","typescript/libraries/file-viewer/src/comments2/plugin/annotation_banner","typescript/libraries/comments2/src/mentions/index","typescript/component_libraries/files_components/src/blades/comments/data/store","typescript/libraries/file-viewer/src/comments2/logging_middleware","typescript/libraries/file-viewer/src/comments2/plugin/navigation_middleware","typescript/libraries/file-viewer/src/comments2/plugin/comment_markers","ts-key-enum","typescript/libraries/comments2/src/components/utils/thread_utils","typescript/libraries/comments2/src/components/utils/approval_utils","typescript/libraries/file-viewer/src/core/utils/extension_constants","typescript/libraries/file-viewer/src/core/utils/paths","dig-components/progress_indicators","typescript/libraries/file-viewer/src/keyboard/keyboard_connector","typescript/libraries/file-viewer/src/keyboard/bindings","typescript/libraries/api_v2/redux/stickers","typescript/libraries/file-viewer/src/core/types/preview_type","typescript/libraries/file-viewer/src/core/logging/constants","typescript/libraries/comments2/src/components/types/index","typescript/libraries/comments2/src/components/comment_editor/components/record_button"],(function(e,t,i,n,s,r,a,o,l,c,d,p,h,u,m,f,g,v,y,C,I,b,_,E,w,R,S,A,O){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Comments2Plugin=t.DEFAULT_COMMENTS_CONFIGURATION=t.MentionsIOClient=void 0,n=i.__importStar(n),Object.defineProperty(t,"MentionsIOClient",{enumerable:!0,get:function(){return p.MentionsIOClient}}),t.DEFAULT_COMMENTS_CONFIGURATION={showApproval:!0,dragSectionAnnotationEnabled:!1};const T=n.default.lazy(()=>i.__awaiter(void 0,void 0,void 0,(function*(){const{CommentsPluginPane:t}=yield new Promise((t,i)=>{e(["typescript/libraries/file-viewer/src/comments2/plugin/pane"],t,i)}).then(i.__importStar);return{default:t}})));T.displayName="LazyCommentsPluginPane";const x=n.default.lazy(()=>i.__awaiter(void 0,void 0,void 0,(function*(){const{AnnotationLayer:t}=yield new Promise((t,i)=>{e(["typescript/libraries/file-viewer/src/comments2/plugin/layer/annotation_layer"],t,i)}).then(i.__importStar);return{default:t}})));x.displayName="LazyAnnotationLayer";const P=()=>n.default.createElement("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%"}},n.default.createElement(b.Spinner,{className:"comments-blade-loading-spinner",size:"standard"}));P.displayName="LoadingIndicator";const L=e=>n.default.createElement(n.default.Suspense,{fallback:n.default.createElement(P,null)},n.default.createElement(T,Object.assign({},e)));L.displayName="AsyncCommentsPluginPane";const M=e=>n.default.createElement(n.default.Suspense,{fallback:n.default.createElement(n.default.Fragment,null,e.children)},n.default.createElement(x,Object.assign({},e)));M.displayName="AsyncAnnotationLayer";t.Comments2Plugin=class{constructor(e,p,b={},T,x,P){this.didRequestfocus=!1,this.didRequestActivateThread=!1,this.loadMediaFeatures=()=>i.__awaiter(this,void 0,void 0,(function*(){try{const e=yield this.platform.apiv2ClientBase.ns("media_addon").rpc("get_features",void 0,{});this.store.dispatch((0,a.getFeaturesResultAction)({result:e,arg:void 0}));const t=e.frame_precise_comments;null!=t&&this.context.getPluginData().navigation.toggleVideoFrameSteppers(t)}catch(e){this.store.dispatch((0,a.getFeaturesResultAction)({arg:void 0},null,e))}})),this.isSupported=e=>(0,C.resolvePreviewTypeFromExtension)((0,I.getFileExtension)(e.name))!==R.PreviewType.CloudDoc,this.handleCancelAnnotating=()=>{this.store.getState().annotationSettings.state&&this.store.dispatch((0,o.cancelAnnotating)(this.context.fileViewerId))},this.openRightRailComments=()=>{this.context.getPluginData().navigation.openRightRailPlugin(S.UserActionContext.RightRail,c.COMMENTS_PLUGIN_ID)},this.handleCaptureRailInteraction=()=>{const{featureVariant:e,hasSeenCaptureExpRef:t,emitter:i,isRecorderShownRef:n}=this.captureState||{},{showTooltip:s}=k(e,null==t?void 0:t.current,null==n?void 0:n.current);s&&this.openRightRailComments(),null==i||i.on("capture-link",this.openRightRailComments)},this.layerUI={LayerWithEventBubbling:e=>n.default.createElement(s.Provider,{store:this.store},n.default.createElement(M,Object.assign({platform:this.platform,context:this.context,config:this.config},e)))},this.rightRailUI={Control:e=>{var t;return this.handleCaptureRailInteraction(),e.file&&this.isSupported(e.file)?n.default.createElement(s.Provider,{store:this.store},n.default.createElement(o.CollapsedCommentsBladeButton,{id:c.COMMENTS_PLUGIN_ID,intl:this.platform.intl,fileId:null===(t=e.file)||void 0===t?void 0:t.fileId,sharedLinkURL:e.file.url})):null},Header:()=>{const e=this.context.getPluginData().previewType;return n.default.createElement(s.Provider,{store:this.store},n.default.createElement(d.AnnotationBanner,{fileViewerId:this.context.fileViewerId,previewType:e,dragSectionAnnotationEnabled:this.config.dragSectionAnnotationEnabled}))},VideoSeekBarLayer:e=>n.default.createElement(s.Provider,{store:this.store},n.default.createElement(f.CommentMarkers,Object.assign({},e))),Sidebar:e=>{const{featureVariant:t,hasSeenCaptureExpRef:i,isRecorderShownRef:r}=this.captureState||{},{showTooltip:a,setShowTooltip:l}=k(t,null==i?void 0:i.current,null==r?void 0:r.current),d=Object.assign(Object.assign({},this.captureState),{showTooltip:a,setShowTooltip:l,onImpression:this.logCaptureExperimentImpressionOnce});return this.isSupported(e.file)?n.default.createElement(s.Provider,{store:this.store},n.default.createElement(_.KeyboardBindingConnector,{name:"comment_plugin",keyboardBindings:this.keybinding}),n.default.createElement(o.CommentsBlade,{id:c.COMMENTS_PLUGIN_ID,intl:this.platform.intl,fileId:e.file.fileId,sharedLinkURL:e.file.url,dragSectionAnnotationEnabled:this.config.dragSectionAnnotationEnabled,approvalIOClient:this.approvalIOClient},n.default.createElement(L,Object.assign({getAccountData:this.promisedAccount,intl:this.platform.intl,context:this.context,config:this.config,approvalIOClient:this.approvalIOClient,captureState:d},e)))):null},isBladeSupported:e=>this.isSupported(e),mediaScrubber:{onClickOutsideMarkers:()=>{this.store.dispatch((0,o.deactivateAllThreads)({fileViewerId:this.context.fileViewerId}))}}},this.fetchInitialComments=(e,t)=>{const i=e.url||(null==t?void 0:t.url)||void 0;if(i){const e={include_permissions:!0,stream:{identifier:{".tag":"shared_link_details",url:i},type:{".tag":"file"}}};this.isLoggedOut?this.store.dispatch((0,r.loggedOutListCommentsAction)({arg:e})):this.store.dispatch((0,r.listCommentsAction)({arg:e}))}else this.store.dispatch((0,r.listCommentsAction)({arg:{include_permissions:!0,stream:{identifier:{".tag":"file_path_or_id",file_path_or_id:e.fileId},type:{".tag":"file"}}}}))},this.lifecycle={previewDidError:()=>{const e=this.context.getPluginData(),{file:t,sharedLinkInfo:i}=e;t&&this.fetchInitialComments(t,i)},previewDidInitialize:({threadId:e,shouldFocusApproval:t,shouldFocusComment:i,commentId:n})=>{const s=this.context.getPluginData(),{file:r,sharedLinkInfo:a}=s;if(null==r)throw new Error("Expected non-null file when preview initialized");if(this.fetchInitialComments(r,a),this.logCaptureExperimentQualify(),"string"!=typeof e||this.didRequestActivateThread){if("string"==typeof n&&!this.didRequestActivateThread){s.navigation.openRightRail(S.UserActionContext.RightRail);const e=r.url||r.fileId,t=Object.values(this.store.getState().threads[e]),i=(0,v.findCommentThread)(t,n);i&&this.store.dispatch((0,o.activateThread)({fileId:r.fileId,sharedLinkURL:r.url,fileViewerId:this.context.fileViewerId,threadId:i.thread.id,isThirdParty:i.thread.isThirdParty})),this.didRequestActivateThread=!0}}else s.navigation.openRightRail(S.UserActionContext.RightRail),this.store.dispatch((0,o.activateInitialThread)({fileViewerId:this.context.fileViewerId,threadId:e,fileId:r.fileId})),this.didRequestActivateThread=!0;if(t&&this.store.dispatch((0,l.setApprovalForm)({[r.fileId]:{activeForm:"request",threadId:void 0}})),"string"==typeof n){const e=r.url||r.fileId,t=Object.values(this.store.getState().threads[e]),i=(0,v.findCommentThread)(t,n);if(i){const t=(0,y.findActionableApprovalCommentId)(i.thread),n=i.thread.comments.find(({id:e})=>e===t);n&&(0,y.canRespondToApproval)(n)&&this.store.dispatch((0,l.setApprovalForm)({[e]:{activeForm:"respond",threadId:i.thread.id}}))}}i&&!this.didRequestfocus&&(s.navigation.openRightRail(S.UserActionContext.RightRail),this.store.dispatch((0,o.focusEditor)(this.context.fileViewerId)),this.didRequestfocus=!0)},previewWillTeardown:()=>{null!=this.store.getState().annotationSettings.state&&this.store.dispatch((0,o.cancelAnnotating)(this.context.fileViewerId));const{emitter:e}=this.captureState||{};null==e||e.off("capture-link",this.openRightRailComments)}},this.logCaptureExperimentQualify=()=>{const{featureVariant:e,logger:t,isRecorderShownRef:i}=this.captureState||{};this.captureState&&t&&("V1"===e||"CONTROL"===e)&&(null==i?void 0:i.current)&&(null==t||t.logToProEvents(A.CommentsCaptureLogEvents.QUALIFY,{experiment:O.CAPTURE_COMMENTS_EXPERIMENT,variant:e}))},this.logCaptureExperimentImpressionOnce=e=>{const{featureVariant:t,logger:i}=this.captureState||{},{captureExperiment:n}=this.store.getState();this.captureState&&i&&"V1"===t&&!n.hasLoggedImpression&&e&&(null==i||i.logToProEvents(A.CommentsCaptureLogEvents.IMPRESSION,{experiment:O.CAPTURE_COMMENTS_EXPERIMENT,variant:t}),this.store.dispatch((0,o.setHasLoggedCaptureImpression)(!0)))};const N=(0,m.createMiddleware)(p);this.store=(0,h.makeStore)({apiv2ClientBase:e.apiv2ClientBase,boltIOClient:T.boltIOClient,mentionsIOClient:T.mentionsIOClient,logger:e=>{p.logUserAction(e.event,"right_sidebar",e.extra)}},[N,u.middleware]),this.platform=e,this.context=p,this.config=Object.assign(Object.assign({},t.DEFAULT_COMMENTS_CONFIGURATION),b),this.approvalIOClient=T.approvalIOClient,this.captureState=P,this.keybinding=[(0,E.getKeyboardBinding)({key:g.Key.Escape,callback:this.handleCancelAnnotating})],this.promisedAccount=e.apiv2ClientBase.ns("users").rpc("get_current_account",void 0,{}),this.isLoggedOut=x,this.loadMediaFeatures(),this.store.dispatch((0,w.getStickersAction)({arg:void 0}))}};const k=(e="OFF",t=!0,i=!1)=>{const[s,r]=(0,n.useState)("V1"===e&&!t&&i);return{showTooltip:s,setShowTooltip:r}}}));
//# sourceMappingURL=comment_plugin.min.js-vflcxC7ph.map